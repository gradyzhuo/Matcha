#!/bin/bash
#
# build
#
# Matcha 1.0, Created by gradyzhuo, enoch_lee.
# Copyright © 2017, Matcha Inc. All rights reserved.
#


@exec basic

source .envs
source .prefix "$@"

if [[ "${array[@]}" =~ "-ndp" ]]; then
  NEED_DOWNLOAD_PROVISION_PROFILE=1
fi

#如無預設之 WORKSPACE ，預設與 BUILDER_BASE 一致
if [[ "$WORKSPACE" == "" ]]; then

  if [[ "$APP_PATH" != "" ]]; then
    WORKSPACE="$APP_PATH"
  else
    WORKSPACE="$MATCHA_BUILDER_BASE"
  fi

fi

#相關路徑之預設
OUTCOME_PATH="$WORKSPACE/outcome"
EXPORT_FOLDER="$OUTCOME_PATH/export"
LOG_FOLDER="$OUTCOME_PATH/log"

PROVISIONING_FOLDER="$WORKSPACE/ProvisioningProfiles"

TEMP_FOLDER=".tmp"
TMP_PATH="$WORKSPACE/$TEMP_FOLDER"
BUILD_PATH="$TMP_PATH/build"
EXPORT_OPTION_PLIST_FOLDER="$TMP_PATH/export_option"
if [[ "$APP_PATH" == "" ]]; then
  APP_PATH="$TMP_PATH/app"
fi

show_help_if_needed $@

#=====Common imports=====
@import Foundation
@import DelegateSupport
@import XC

setup_delegate "$@"

if [[ -e "$APP_PATH" ]]; then
  switch_dir_to "$APP_PATH"
  if [[ -e "$DELEGATE_FILE_NAME" && "$SOURCE_TYPE" == "path" && "$APP_PATH" != "" && "$DELEGATE" == "" ]]; then
    DELEGATE="$APP_PATH/$DELEGATE_FILE_NAME"
  fi
  restore_dir
fi

read_delegate "$DELEGATE"

will_launch "$@"

clean tmp

validate_env_variables

keychain unlock $PASSWD

did_launch

will_exec "builder"
exec_script _init

if [[ "$SOURCE_TYPE" == "git" ]]; then
  exec_script clone_app
fi

phase_print "Configuring path..."

config_env_variables
mkdirs "log" "export"
mkdirFolder "$TMP_PATH"

declare -i configurations_count=${#BUILD_CONFIGURATIONS[@]}
if [[ $configurations_count == 0 ]]; then
  switch_dir_to "$APP_PATH"
  BUILD_CONFIGURATIONS=($(xcodebuild -showBuildSettings | grep 'CONFIGURATION =' | sed 's/    CONFIGURATION = //g'))
  restore_dir
fi

for (( i=0; i<${configurations_count}; i++ ));
do
  switch_dir_to "$APP_PATH"

	BUILD_CONFIGURATION=${BUILD_CONFIGURATIONS[$i]}
	print -c green "using configuration: $BUILD_CONFIGURATION"

	if [[ $BUILD_CI != 0 ]]; then
		EXPORT_FOLDER="$EXPORT_FOLDER/${BUILD_CONFIGURATION}_${BUILD_DATETIME}"
	fi

  #===== variables from xcode projects
  xc_setup_variables
  #=============================
	ARCHIVE_NAME="${PROJ_NAME}_${BUILD_CONFIGURATION}"
	EXPORT_SUB_FOLDER="${BUILD_CONFIGURATION}_${BUILD_DATETIME}"

  exec_script setup_codesign
  exec_script archive_app
	exec_script export_ipa

	APP_ID=""
	UUID=""

  restore_dir
done

did_exec "builder"

did_end
